<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Flipbook PDF (Turn.js)</title>

  <style>
    :root{--bg:#0f1115;--ink:#eaeaea;--muted:#8a8f98;--card:#0b0d11;--border:#2a2f39}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 12px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;position:sticky;top:0;padding:10px;border-radius:12px;background:rgba(15,17,21,.7);backdrop-filter:blur(8px)}
    select,button{border:1px solid var(--border);background:#1a1f27;color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    .spacer{flex:1}
    .page-count{color:var(--muted);font-variant-numeric:tabular-nums}
    .links{display:flex;gap:12px;align-items:center;color:var(--muted);margin:8px 0 0;flex-wrap:wrap}
    .links a{color:#bcd;text-decoration:none}
    .links a:hover{text-decoration:underline}
    .book-shell{width:100%;height:min(80vh,800px);border-radius:16px;overflow:hidden;background:var(--card);box-shadow:0 10px 30px rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;margin-top:12px}
    #book{width:960px;height:640px} /* ratio paysager par d√©faut, Turn.js s'adapte au container */
    .page{background:#fff;overflow:hidden}
    .page img{display:block;width:100%;height:100%;object-fit:contain;background:#fff}
    .loader{color:var(--muted);font-size:14px;text-align:center;padding:8px 12px}
    .err{color:#ff9b9b}
    @media (max-width:900px){ #book{width:100%;height:100%} }
  </style>

  <script>
    // util: charger un script synchronement (sans async/defer) + attendre qu'il soit pr√™t
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src=src; s.async=false;
        s.onload=()=>resolve(src);
        s.onerror=()=>reject(new Error("load fail: "+src));
        document.head.appendChild(s);
      });
    }

    // Loader robuste: PDF.js (legacy/UMD) ‚Äî CDN ‚Üí CDN ‚Üí GitHub ‚Üí LOCAL
    (function(){
      const PDF_BASES = [
        "https://unpkg.com/pdfjs-dist@4.5.136/legacy/build/",
        "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.5.136/legacy/build/",
        "https://cdn.jsdelivr.net/gh/mozilla/pdfjs-dist@v4.5.136/legacy/build/",
        "vendor/pdfjs/" // fallback local si pr√©sent dans le repo
      ];
      window.__pdfjsReady = (async ()=>{
        let base=null,lastErr=null;
        for(const b of PDF_BASES){
          try{
            await loadScript(b+"pdf.min.js");
            window.pdfjsLib = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
            if (window.pdfjsLib && typeof pdfjsLib.getDocument==="function"){
              pdfjsLib.GlobalWorkerOptions.workerSrc = b+"pdf.worker.min.js";
              console.log("[flipbook] PDF.js via", b);
              base=b; break;
            }
          }catch(e){ lastErr=e; }
        }
        if(!base) throw new Error("PDF.js introuvable (r√©seau/CSP) ‚Äî ajoute vendor/pdfjs/ en local.");
      })();
    })();

    // Loader robuste: Turn.js ‚Äî unpkg ‚Üí jsDelivr
    (function(){
      const TURN_JS = [
        "https://unpkg.com/turn.js@4/turn.min.js",
        "https://cdn.jsdelivr.net/npm/turn.js@4/turn.min.js"
      ];
      window.__turnReady = (async ()=>{
        let ok=false,lastErr=null;
        for (const src of TURN_JS){
          try{ await loadScript(src); if (typeof window.jQuery==="undefined"){ await loadScript("https://code.jquery.com/jquery-3.6.0.min.js"); } ok=typeof jQuery!=="undefined" && typeof jQuery.fn.turn==="function"; if(ok){ console.log("[flipbook] Turn.js via", src); break; } }
          catch(e){ lastErr=e; }
        }
        if(!ok) throw new Error("Turn.js introuvable ‚Äî r√©seau/CSP.");
      })();
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Lecteur PDF (Turn.js)</h1>

    <div class="toolbar" role="group" aria-label="Contr√¥les flipbook">
      <label for="pdfSelect" style="font-weight:700;">Document :</label>
      <select id="pdfSelect" aria-label="Choisir un PDF"></select>

      <button id="reload" title="Recharger">Recharger</button>
      <div class="spacer"></div>

      <button id="prev" disabled>‚Üê Pr√©c√©dent</button>
      <button id="next" disabled>Suivant ‚Üí</button>

      <span class="page-count"><span id="pageNow">‚Äî</span> / <span id="pageTotal">‚Äî</span></span>
    </div>

    <div class="book-shell">
      <div id="book"><div class="loader" id="loader">Chargement‚Ä¶</div></div>
    </div>

    <p class="links">
      <a id="downloadLink" href="#" download>üíæ T√©l√©charger le PDF</a>
      <a id="openRaw" href="#" target="_blank" rel="noopener">‚Üó Ouvrir le PDF brut</a>
      <span id="status"></span>
    </p>

    <p class="loader">
      Astuce : pincer/drag pour tourner la page, ou ‚Üê/‚Üí au clavier.<br/>
      <small>Si les CDN sont bloqu√©s, ajoute en option <code>vendor/pdfjs/pdf.min.js</code> et <code>pdf.worker.min.js</code> ; le chargeur basculera tout seul dessus.</small>
    </p>
  </div>

  <script>
  (function(){
    // ---- DOM & constantes
    const MANIFEST = "papers/index.json";
    const RENDER_SCALE = 1.8; // Turn.js pr√©f√®re des images pas trop lourdes
    const JPEG_QUALITY = 0.90;

    const sel = document.getElementById("pdfSelect");
    const btnR= document.getElementById("reload");
    const btnP= document.getElementById("prev");
    const btnN= document.getElementById("next");
    const pageNow = document.getElementById("pageNow");
    const pageTot = document.getElementById("pageTotal");
    const bookEl  = document.getElementById("book");
    const status  = document.getElementById("status");
    const linkDl  = document.getElementById("downloadLink");
    const linkRaw = document.getElementById("openRaw");

    let bookInited=false;

    const qs = new URLSearchParams(location.search);
    const basename = p => (p||"").split("/").pop();
    const ensurePath = f => f.startsWith("papers/") ? f : `papers/${f}`;
    const niceLabel = f => basename(f).replace(/_/g," ").replace(/\.pdf$/i,"");
    const setBusy = t => status.textContent = t || "";
    function setLinks(path){ const p=ensurePath(path); linkDl.href=p; linkRaw.href=p; }
    function setButtons(on){ btnP.disabled=!on; btnN.disabled=!on; }

    function normalizeItems(raw){
      if (!Array.isArray(raw)||raw.length===0) throw new Error("Manifest vide");
      return raw.map(e=>{
        if (typeof e==="string") return { file:e, title:niceLabel(e) };
        return { file:e.file, title:e.title||e.title_short||niceLabel(e.file) };
      });
    }

    async function rasterizeToImages(pdfUrl){
      await window.__pdfjsReady;
      const pdf = await pdfjsLib.getDocument({ url: pdfUrl }).promise;
      const total = pdf.numPages;
      pageTot.textContent = String(total);
      pageNow.textContent = "‚Äî";

      const images = [];
      for (let p=1; p<=total; p++){
        setBusy(`Rendu des pages‚Ä¶ (${p}/${total})`);
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({ scale: RENDER_SCALE });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;
        images.push(canvas.toDataURL("image/jpeg", JPEG_QUALITY));
      }
      return images;
    }

    async function renderTurn(images){
      await window.__turnReady;

      // reset
      bookEl.innerHTML = "";
      const $book = jQuery("<div/>", { class:"magazine" }).appendTo(bookEl);

      // pages: chaque image -> <div class="page"><img/></div>
      images.forEach(src=>{
        const $p = jQuery("<div/>", { class:"page" }).appendTo($book);
        jQuery("<img/>", { src, alt:"page" }).appendTo($p);
      });

      // init Turn.js
      $book.turn({
        width: 960,
        height: 640,
        autoCenter: true,
        gradients: true,
        elevation: 50,
        when: {
          turning: (e, page)=> { pageNow.textContent = String(page); },
          turned:  (e, page)=> { pageNow.textContent = String(page); }
        }
      });

      // boutons
      btnP.onclick = ()=> $book.turn("previous");
      btnN.onclick = ()=> $book.turn("next");
      document.addEventListener("keydown", (e)=>{
        if (e.key==="ArrowLeft") $book.turn("previous");
        if (e.key==="ArrowRight") $book.turn("next");
      });

      bookInited=true;
      setButtons(true);
      setBusy(`Pr√™t ‚Äì ${images.length} page${images.length>1?"s":""}`);
    }

    async function loadAndRender(filePath){
      try{
        setButtons(false);
        bookInited=false;
        bookEl.innerHTML = '<div class="loader">Chargement‚Ä¶</div>';

        const url = ensurePath(filePath);
        localStorage.setItem("flip:last", filePath);
        setLinks(filePath);

        const imgs = await rasterizeToImages(url);
        await renderTurn(imgs);
      }catch(err){
        console.error(err);
        setButtons(false);
        bookEl.innerHTML = `<div class="loader err">‚ùå √âchec : ${(err && err.message) ? err.message : err}</div>`;
        setBusy("");
      }
    }

    // boot
    (async function boot(){
      setBusy("Chargement de la liste‚Ä¶");
      // charge manifest
      let items=[];
      try{
        const r = await fetch(MANIFEST, {cache:"no-store"});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        items = normalizeItems(await r.json());
      }catch(e){
        bookEl.innerHTML = `<div class="loader err">‚ùå Impossible de charger ${MANIFEST}</div>`;
        setBusy("");
        return;
      }

      // peuple select
      sel.innerHTML="";
      for(const it of items){
        const o=document.createElement("option");
        o.value=it.file; o.textContent=it.title; sel.appendChild(o);
      }

      // choix initial
      const fromQS = qs.get("pdf");
      const last   = localStorage.getItem("flip:last");
      if (fromQS){
        const hit = items.find(it => basename(it.file)===basename(fromQS));
        sel.value = hit ? hit.file : items[0].file;
      } else if (last && items.some(it => it.file===last)){
        sel.value = last;
      } else {
        sel.value = items[0].file;
      }

      // update URL
      try{
        const b = basename(sel.value);
        const u = new URL(location.href); u.searchParams.set("pdf", b);
        history.replaceState(null,"",u.toString());
      }catch{}

      // listeners
      sel.addEventListener("change", ()=>{
        try{
          const b = basename(sel.value);
          const u = new URL(location.href); u.searchParams.set("pdf", b);
          history.replaceState(null,"",u.toString());
        }catch{}
        loadAndRender(sel.value);
      });
      btnR.addEventListener("click", ()=> loadAndRender(sel.value));

      // lance rendu initial
      loadAndRender(sel.value);
    })();
  })();
  </script>
</body>
</html>
